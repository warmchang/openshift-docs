:_mod-docs-content-type: ASSEMBLY
[id="rosa-hcp-egress-zero-install"]
= Creating {egress-zero-title}
include::_attributes/attributes-openshift-dedicated.adoc[]
:context: rosa-hcp-egress-zero-install

toc::[]

[role="_abstract"]
Creating {product-title} with {egress-zero} provides a way to enhance your cluster's stability and security by allowing your cluster to use the image registry in the local region if the cluster cannot access the internet. Your cluster first tries to pull the images from Quay, and when they aren't reached, it instead pulls the images from the image registry in the local region.

All public and private clusters with {egress-zero} get their Red{nbsp}Hat container images from an Amazon Elastic Container Registry (ECR) located in the local region of the cluster instead of gathering these images from various endpoints and registries on the internet. ECR provides storage for OpenShift release images as well as Red{nbsp}Hat Operators. All requests for ECR are kept within your AWS network by serving them over a VPC endpoint within your cluster.

{egress-zero-title} use AWS ECR to provision your clusters without the need for public internet. Because necessary cluster lifecycle processes occur over AWS private networking, AWS ECR serves as a critical service for core cluster platform images. For more information on AWS ECR, see link:https://aws.amazon.com/ecr/[Amazon Elastic Container Registry].

You can create a fully operational cluster that does not require a public egress by configuring a virtual private cloud (VPC) and using the `--properties zero_egress:true` flag when creating your cluster.

See xref:../upgrading/rosa-hcp-upgrading.adoc#rosa-hcp-upgrading[Upgrading {product-title} clusters] to upgrade clusters using {egress-zero}.

[NOTE]
====
Clusters created in restricted network environments may be unable to use certain {product-title} features including {red-hat-lightspeed} and Telemetry. These clusters may also experience potential failures for workloads that require public access to registries such as `quay.io`. When using clusters installed with {egress-zero}, you can also install Red Hat-owned Operators from the software catalog. For a complete list of Red Hat-owned Operators, see the link:https://catalog.redhat.com/search?searchType=software&target_platforms=Red%20Hat%20OpenShift&deployed_as=Operator&p=1&partnerName=Red%20Hat%2C%20Inc.%7CRed%20Hat[Red{nbsp}Hat Ecosystem Catalog]. Only the default Operator channel is mirrored for any Operator that is installed with {egress-zero}.
====

[id="rosa-hcp-egress-zero-install-prerequisites_{context}"]
== Prerequisites

* You have an AWS account with sufficient permissions to create VPCs, subnets, and other required infrastructure.
* You have installed the Terraform v1.4.0+ CLI.
* You have installed the ROSA v1.2.45+ CLI.
* You have installed and configured the AWS CLI with the necessary credentials.
* You have installed the git CLI.
* You have enabled the necessary xref:../rosa_planning/rosa-sts-aws-prereqs.adoc#firewall-cli-bastion_rosa-hcp-aws-prereqs[ROSA CLI firewall rules] and xref:../rosa_planning/rosa-sts-aws-prereqs.adoc#firewall-hcm-bastion_rosa-hcp-aws-prereqs[{hybrid-console} firewall rules].

[IMPORTANT]
====
* You can use {egress-zero} on all supported versions of {product-title} that use the hosted control plane architecture; however, Red{nbsp}Hat suggests using the latest available z-stream release for each {ocp} version.

* While you may install and upgrade your clusters as you would a regular cluster, due to an upstream issue with how the internal image registry functions in disconnected environments, your cluster that uses {egress-zero} will not be able to fully use all platform components, such as the image registry. You can restore these features by using the latest ROSA version when upgrading or installing your cluster.
====

include::modules/rosa-glossary-disconnected.adoc[leveloffset=+1]

include::modules/rosa-hcp-set-environment-variables.adoc[leveloffset=+1]

include::modules/rosa-hcp-egress-zero-install-creating.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* link:https://docs.aws.amazon.com/vpc/latest/userguide/vpc-getting-started.html[Get Started with Amazon VPC]

include::modules/rosa-hcp-create-network.adoc[leveloffset=+2]

include::modules/rosa-hcp-vpc-subnet-tagging-rosa-network.adoc[leveloffset=+3]

[role="_additional-resources"]
.Additional resources

* link:https://aws.amazon.com/cloudformation/[AWS CloudFormation documentation]
* link:https://github.com/openshift/rosa/blob/master/cmd/create/network/templates/rosa-quickstart-default-vpc/cloudformation.yaml[Default VPC AWS CloudFormation template]

include::modules/rosa-hcp-vpc-terraform.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* link:https://developer.hashicorp.com/terraform[HashiCorp Terraform documentation]
* link:https://github.com/openshift-cs/terraform-vpc-example/tree/main/zero-egress[Egress zero Terraform VPC Example]

// Adding a new context to reuse the subnet tagging module for the terraform example.
:context: rosa-hcp-egress-zero-install-terraform
include::modules/rosa-hcp-vpc-subnet-tagging-rosa-network.adoc[leveloffset=+3]

[role="_additional-resources"]
.Additional resources

* link:https://github.com/openshift-cs/terraform-vpc-example[Terraform VPC example]

// Reset the context to the original value.
:context: rosa-hcp-egress-zero-install
include::modules/rosa-hcp-vpc-aws.adoc[leveloffset=+2]

include::modules/rosa-hcp-vpc-manual.adoc[leveloffset=+2]

include::modules/rosa-hcp-vpc-subnet-tagging.adoc[leveloffset=+3]

[role="_additional-resources"]
.Additional resources

* link:https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/deploy/subnet_discovery/[Subnet Auto Discovery]

include::modules/vpc-troubleshooting.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* xref:../support/troubleshooting/rosa-troubleshooting-installations-hcp.adoc#rosa-troubleshooting-installations-hcp[Troubleshooting {product-title} cluster installations]
* xref:../support/getting-support.adoc#getting-support[Getting support for Red{nbsp}Hat OpenShift Service on AWS]

include::modules/rosa-hcp-creating-account-wide-sts-roles-and-policies.adoc[leveloffset=+1]

include::modules/rosa-sts-byo-oidc.adoc[leveloffset=+1]

include::modules/rosa-operator-config.adoc[leveloffset=+1]

include::modules/rosa-hcp-sts-creating-a-cluster-egress-lockdown-cli.adoc[leveloffset=+1]
