// Module included in the following assemblies:
//
// * authentication/sd-configuring-identity-providers.adoc
// * rosa_hcp/terraform/rosa-hcp-creating-a-cluster-quickly-terraform.adoc

:_mod-docs-content-type: PROCEDURE
ifeval::["{context}" == "rosa-hcp-creating-a-cluster-quickly-terraform"]
:tf-config:
endif::[]

[id="config-htpasswd-idp-terraform_{context}"]
= Configuring an htpasswd identity provider with Terraform

ifdef::tf-config[]
[role="_abstract"]
After creating your cluster with Terraform, you can permit users access to your cluster by using an htpasswd identity provider (IDP) with the Terraform tool.
endif::tf-config[]
ifndef::tf-config[]
[role="_abstract"]
You can create an htpasswd identity provider (IDP) with Terraform.
endif::tf-config[]

.Prerequisites

* You have installed and configured the latest version of the {rosa-cli}.
* You have installed and configured the latest version of Terraform.

.Procedure
ifndef::tf-config[]
. Grant permissions to your account by using link:https://console.redhat.com/openshift/token[an offline {cluster-manager-first} token].
. Copy your offline token, and set the token as an environmental variable by running the following command:
+
[source,terminal]
----
$ export RHCS_TOKEN=<your_offline_token>
----
+
[NOTE]
====
This environmental variable resets at the end of each session, such as restarting your machine or closing the terminal.
====
endif::tf-config[]

. Create the `htpasswd_idp.tf` file by running one of the following commands:
+
** *Option 1*: To create a user with a generated, randomized password, run:
+
[source,terminal]
----
$ cat<<-EOF>htpasswd_idp.tf
  module "htpasswd_idp" {
    source = "terraform-redhat/rosa-hcp/rhcs//modules/idp"
    version = "1.6.2"

    cluster_id         = "2odpb9p344hnkfvpkluo00qmgkika78l"
    name               = "htpasswd-idp-tf-1"
    idp_type           = "htpasswd"
    htpasswd_idp_users = [{ username = "pej-user-d1", password = random_password.password.result }]
  }
  
  resource "aws_secretsmanager_secret" "idp_password" {
  name        = "idp-password-secret"
  description = "Any description here" 
  }

  resource "random_password" "password" {
      length           = 16
      lower            = true
      special          = true
      override_special = "!#$%&*()-_=+[]{}<>:?"
  }

  # If you need to output the password, mark it as sensitive to hide from CLI logs
  output "password_output" {
      value     = random_password.password.result
      sensitive = true
  }
  
  # This section sends your credentials to your AWS Secrets Manager to enable you to log in to your cluster.
  resource "aws_secretsmanager_secret_version" "idp_password_val" {
  secret_id     = aws_secretsmanager_secret.idp_password.id
  secret_string = random_password.password.result
  }
EOF
----
+
You must replace the `<cluster_id>` placeholder with the 32-digit ID for your cluster. To find that value, run `rosa list clusters | awk '{print $1}'`. You also must replace the `<user_name>` placeholder with the username you want to create. The randomized password is then stored in your AWS Secrets manager to be used when logging in to the cluster.

*** Run the following command to view your password after setting it:
+
[source,terminal]
----
$ terraform output password_output
----
+
The CLI returns your generated password in plain text.

** *Option 2*: To specify your passwords when creating a user, run:
+
[source,terminal]
----
$ cat<<-EOF>htpasswd_idp.tf
  module "htpasswd_idp" {
    source = "terraform-redhat/rosa-hcp/rhcs//modules/idp"
    version = "1.6.2"

    cluster_id         = "<cluster_id>"
    name               = "htpasswd-idp"
    idp_type           = "htpasswd"
    htpasswd_idp_users = [{ username="<user_name>",password="<password>"}]
  }
EOF
----
+
You must replace the `<cluster_id>` placeholder with the 32-digit ID for your cluster. To find that value, run `rosa list clusters | awk '{print $1}'`. You also must replace the `<user_name>` placeholder with the username you want to create as well as a password for the `<password>` placeholder.

. Run the following command to set up Terraform to create your resources based on your Terraform files:
+
[source,terminal]
----
$ terraform init
----

. Verify that the Terraform you copied is correct by running the following command:
+
[source,terminal]
----
$ terraform validate
----
+
.Example output
[source,terminal]
----
Success! The configuration is valid.
----

. Create your cluster with Terraform by running the following command:
+
[source,terminal]
----
$ terraform apply
----

. Enter `yes` to proceed or `no` to cancel when the Terraform interface lists the resources to be created or changed and prompts for confirmation:
+
[source,terminal]
----
Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes
----
+
You see a confirmation that your IDP has been created.
+
[source,terminal]
----
Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
----
+
[NOTE]
====
If you used the randomized password template, then the generated password is stored in your AWS Secrets manager.
====

ifeval::["{context}" == "rosa-hcp-creating-a-cluster-quickly-terraform"]
:!tf-config:
endif::[]